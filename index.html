<!DOCTYPE html>
<html>
<head>
	
	<title>Bikemap</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
  <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="leaflet-gpx.js"></script>

    <!--LOADING ELEVATION PLUGIN-->
    <link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.css" />
    <script src="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="src/leaflet.legend.css" />
    <script type="text/javascript" src="src/leaflet.legend.js"></script>

</head>

    
<div id="map" style="height: 100vh;"></div>
<div class="demo-card-wide mdl-card mdl-shadow--2dp" id="info-card" style="visibility: hidden;">
    <div class="mdl-card__title">
      <h2 class="mdl-card__title-text" id="item-title" >Welcome</h2>
    </div>
    <div class="mdl-card__supporting-text" id="item-content">
        hello
    </div>
    <div class="elevation" id="elevation-div"></div>
    <div id="disqus_thread"></div>
    
    <div class="mdl-card__actions mdl-card--border">
      <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="gpx-download">
        Download GPX
      </a>
    </div>
    <div class="mdl-card__menu">
      <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
        <i class="material-icons">link</i>
      </button>
    </div>
  </div>
  
<script>
  //Map Color Variables
  var roadColor = '#4AA96C'
  var connectorColor = '#FFE162'
  var gravelColor = '#009DAE'
  var reconColor = '#9D84B7'
  var cautionColor = '#D9534F'

  //Initializing the Map
  var opts = {
      map: {
        center: [49.252752, -123.161156],
        zoom: 10,
        mapTypeId: 'topo',
        fullscreenControl: false,
        zoomControl: false,
        searchControl: false,
        loadingControl: true,
        disableDefaultUI: true,
        pegmanControl: false,
        
      },
      points: {
        icon: {
          iconUrl: 'https://unpkg.com/@raruto/leaflet-elevation@1.3.5/images/elevation-poi.png',
          iconSize: [12, 12],
        },
      },
      elevation: {
        theme: "custom-theme",
        detachedView: true,
        elevationDiv: '#elevation-div',
        followPositionMarker: true,
        zFollow: 15,
        legend: false,
      },
    };

	var map = L.map('map', opts.map);

  var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/dark-v10',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(map);




  //Loading GPX from JSON

  function loadGPX(fileList) {
    console.log("---- Loading GPX via JSON ----")
    for (i in fileList){
      console.log(encodeURI(fileList[i].path))
      switch (fileList[i].type){
        case "1-road":
          plotGPX(encodeURI(fileList[i].path), roadColor);
          break;
        case "2-connector":
          plotGPX(encodeURI(fileList[i].path), connectorColor);
          break;
        case "3-gravel":
          plotGPX(encodeURI(fileList[i].path), gravelColor);
          break;
        case "4-recon":
          plotGPX(encodeURI(fileList[i].path), reconColor, "10 5");
          break;
        case "5-caution":
          plotGPX(encodeURI(fileList[i].path), cautionColor);
          break;
        } 

    
    }

}
 

  function plotGPX(path, color, style) {

  //console.log(gpxList[i])
    var gpx = new L.GPX(path, {
        polyline_options: {
            color: color,
            opacity: 1,
            weight: 2,
            dashArray: style,
            lineCap: 'round'
        }
    }, {
        async: true
    }).on('loaded', function(e) {
        map.fitBounds(e.target.getBounds());
    }).addTo(map);

    gpx.on('mouseover', function(e) {
        var gpx2 = e.target,
            name = gpx2.get_name()
        gpx2.setStyle({
            weight: 6
        });

        var popLocation = e.latlng;
        var popup = L.popup()
            .setLatLng(popLocation)
            .setContent(name)
            .openOn(map);
    });

    //Callback function for when plot lines are selected
    gpx.on('click', function(e) {
                //Disqus Reset 
                DISQUS.reset({
                    reload: true,
                    config: function() {
                        this.page.identifier = "clear";
                        this.page.url = ("http://tripreport.tk/#!" + encodeURIComponent(gpx2.get_name()));
                    }
                });
                
                //Stops the map layer from also receiving a click request
                L.DomEvent.stopPropagation(e);
                
                var gpx2 = e.target;
                distM = gpx2.get_distance(),
                    distKm = distM / 1000,
                    distKmRnd = distKm.toFixed(1),
                    eleGain = gpx2.get_elevation_gain().toFixed(0),
                    eleLoss = gpx2.get_elevation_loss().toFixed(0);
                gpx2.setStyle({
                    weight: 5
                });
                var info = "Distance: " + distKmRnd + " km </br>"
                console.log(encodeURIComponent(gpx2.get_name()))
                loadDisqus(document.getElementById("disqus_thread"), gpx2.get_name(), (encodeURIComponent(gpx2.get_name())))
                window.location.hash = ('!' + encodeURIComponent(gpx2.get_name()));
                document.getElementById("info-card").style.visibility = "visible";
                document.getElementById("item-title").innerHTML = gpx2.get_name();
                document.getElementById("item-content").innerHTML = info;
                document.getElementById("gpx-download").href = e.target._gpx;
                el.clear();

                var g = new L.GPX(e.target._gpx, {
                    async: true
                });
                g.on("addline", function(e) {
                    el.addData(e.line);
                });



g.addTo(map);
                
                
                //controlElevation.load(e.target._gpx);

                gpx2.setStyle({
                    weight: 3
                });
            });

	gpx.on('mouseout', function(e) {
      map.closePopup();
      var gpx2 = e.target
      gpx2.setStyle({
                    weight: 2
                });
    });

        

    }


function loadDisqus(element, postTitle, postUrlTag) {
  var identifier = postTitle;

  // Including the hashbang ('/#!') is important.
  var url = window.location.origin + '/#!' + postUrlTag;

  var disqus_identifier = identifier;
  var disqus_url = url;

  if (window.DISQUS) {
    // Horrible, but jQuery wasn't removing the div elements fully
    $( ".comments-load" ).each(function() {
      var len = this.childNodes.length;
      for(var i = 0; i < len; i++)
      {  
        if (this.childNodes[i].tagName == "DIV") {
          this.removeChild(this.childNodes[i]);
        } 
      }
    });

    $(element).append('<div class="disqus-thread" id="disqus_thread"></div>');

    /** if Disqus exists, call it's reset method with new parameters **/
    DISQUS.reset({
      reload: true,
      config: function () { 
        //important to convert it to string
        this.page.identifier = identifier.toString();    
        this.page.url = url;
      }
    });
  }
};


   



    map.on('click', function(e){
        document.getElementById("info-card").style.visibility = "hidden";
        el.clear();
        console.log(window.location.hash);
        window.location.hash = '';

        DISQUS.reset({
                reload: true,
                config: function () {  
                  this.page.identifier = "clear";  
                  this.page.url = ("http://tripreport.tk/#!" + encodeURIComponent(gpx2.get_name()));
                }});
        //controlElevation = L.control.elevation(elevation_options).remove(map);
 
    })



	
	
	




var el = L.control.elevation({
  	position: "topright",
	theme: "steelblue-theme", //default: lime-theme
	width: 600,
	height: 200,
	margins: {
		top: 10,
		right: 20,
		bottom: 30,
		left: 50
	},
	useHeightIndicator: true, //if false a marker is drawn at map position
	interpolation: d3.curveLinear, //see https://github.com/d3/d3-shape/blob/master/README.md#area_curve
	hoverNumber: {
		decimalsX: 3, //decimals on distance (always in km)
		decimalsY: 0, //deciamls on hehttps://www.npmjs.com/package/leaflet.coordinatesight (always in m)
		formatter: undefined //custom formatter function may be injected
	},
	xTicks: 4, //number of ticks in x axis, calculated by default according to width
	yTicks: 4, //number of ticks on y axis, calculated by default according to height
	collapsed: false,  //collapsed mode, show chart on click or mouseover
	imperial: false    //display imperial units instead of metric
});
el.addTo(map);

L.control.legend({
    position: "topleft",
    legends: [{
                label: "Road",
                type: "polyline",
                color: roadColor,
                fillColor: roadColor,
                weight: 2,
                
            },{
                label: "Connector",
                type: "polyline",
                color: connectorColor,
                fillColor: connectorColor,
                weight: 2,
                
            },{
                label: "Gravel",
                type: "polyline",
                color: gravelColor,
                fillColor: gravelColor,
                weight: 2,
                
            },{
                label: "Caution",
                type: "polyline",
                color: cautionColor,
                fillColor: cautionColor,
                weight: 2,
                
            },
            {
                label: "Recon Route",
                type: "polyline",
                color: reconColor,
                fillColor: reconColor,
                dashArray: [10, 5],
                weight: 2
            }
          ]
}).addTo(map);

  //Loading Data Call
  $.getJSON( "folder.json" , function( result ){
      loadGPX(result);
  });


</script>

<script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://bikemap-v1.disqus.com/embed.js';
  s.async = "true";
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();

  



</script>
<script id="dsq-count-scr" src="bikemap-v1.disqus.com/count.js" async></script>
</body>
</html>
