<!DOCTYPE html>
<html>
<head>
	
	<title>Bikemap</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
  <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="leaflet-gpx.js"></script>
    <link rel="stylesheet" href="css/font-awesome.css">


    <!--LOADING ELEVATION PLUGIN-->
    <link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation@2.1.0/dist/leaflet-elevation.min.css" />
    <script src="src/leaflet-elevation.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="src/leaflet.legend.css" />
    <script type="text/javascript" src="src/leaflet.legend.js"></script>

    <script type="text/javascript" src="src/leaflet-sidebar.js"></script>
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />

    <script type="text/javascript" src="https://unpkg.com/showdown/dist/showdown.min.js"></script>

</head>

    
<div id="map" style="height: 100vh;"></div>


<div id="sidebar" class="leaflet-sidebar collapsed">
  <!-- Nav tabs -->
  <div class="leaflet-sidebar-tabs">
      <ul role="tablist"> <!-- top aligned tabs -->
        <li><a href="#sidebar-info" role="tab"><i class="fa fa-bars"></i></a></li>
      </ul>

      <ul role="tablist"> <!-- bottom aligned tabs -->
          <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
      </ul>
  </div>

  <!-- Tab panes -->
  <div class="leaflet-sidebar-content">
      <div class="leaflet-sidebar-pane" id="sidebar-info">
        
        
 
          <p><test</p>

          <div id="sidebar-info-description"></div>
          

      </div>
      <br>
      <hr style="width:92%;margin-left:4%;">
      <br>
      <div class="elevation" id="elevation-div"></div>
      <div id="data-summary" class="data-summary">

        <div class="data-row">
    
          <span class="totlen">
            <span class="summarylabel">Length: </span>
            <span class="summaryvalue">0</span>
          </span>
          <br>
          <br>
          
          </span>
          <span class="maxele">
            <span class="summarylabel">Max Elevation: </span>
            <span class="summaryvalue">0</span>
          </span>
          <br>
          <span class="minele">
            <span class="summarylabel">Min Elevation: </span>
            <span class="summaryvalue">0</span>
          </span>
    
        </div>

        <div class="data-row">
    
          <span class="gain">
            <span class="summarylabel">Gain: </span>
            <span class="summaryvalue">0</span>
          </span>
          <br>
          <span class="loss">
            <span class="summarylabel">Loss: </span>
            <span class="summaryvalue">0</span>
          </span>
    
        </div>
    
      </div>
      <br>
      <hr style="width:92%;margin-left:4%;">
      <br>
      <div id="disqus_thread"></div>

  </div>
</div>


  
<style>
.data-summary {
			font-family: Verdana, Arial, Helvetica, sans-serif;
			font-size: 12px;
      margin-left: 14px;
      overflow-x: hidden;
      white-space: nowrap; 
		}



		.data-summary .summarylabel,
		.data-summary .summaryvalue {
			display: inline-block;
      overflow-x: hidden;
  
		
		}

		.data-row {
			margin-bottom: 1.5em;
      overflow-x: hidden;
		}

		.elevation-detached.elevation-collapsed .elevation-toggle-icon {
			top: .5em;
		}

/*  ---------------    */

.custom-theme.elevation-control .area path.altitude,
		.custom-theme .legend-altitude rect.area {
			fill: rgba(73, 73, 73, 0.95);  /* fallback color */
			fill-opacity: 0.9;
			stroke: rgba(255, 255, 255,.5);
			stroke-width: 1.5;
		}

.custom-theme.elevation-control .grid .tick line  {
  stroke: rgba(255, 255, 255,.0)!important;
}

		.custom-theme.elevation-control .area path.slope,
		.custom-theme .legend-slope rect {
			fill: url(#blob-pattern);
			fill-opacity: 1;
			stroke: #000;
			stroke-width: 1.5;
		}


    .custom-theme.elevation-control .axis line, 
    .custom-theme.elevation-control .axis path {
      stroke: #fff;
    }

    .custom-theme.elevation-control .axis text {
      stroke: none;
      color: #fff;
      fill: #fff;
      font-weight: 400;
    }

		.custom-theme.height-focus.circle-lower {
			fill: #FF0;
		}

		.custom-theme.elevation-polyline {
			stroke: #F00;
			stroke-opacity: 1;
			stroke-width: 2;
		}

		.custom-theme.elevation-polyline-segments {
			stroke: #FF0;
			stroke-width: 2;
			stroke-dasharray: 4;
		}
	
</style>

<script>
  //Map Color Variables
  var routeColor = '#000000'
  var roadColor = '#4AA96C'
  var connectorColor = '#FFE162'
  var gravelColor = '#009DAE'
  var reconColor = '#9D84B7'
  var cautionColor = '#D9534F'

  //Initializing the Map
  var opts = {
      map: {
        center: [49.252752, -123.161156],
        zoom: 10,
        mapTypeId: 'topo',
        fullscreenControl: false,
        zoomControl: false,
        searchControl: false,
        loadingControl: true,
        disableDefaultUI: true,
        pegmanControl: false,
        
      },
      points: {
        icon: {
          iconUrl: 'https://unpkg.com/@raruto/leaflet-elevation@1.3.5/images/elevation-poi.png',
          iconSize: [12, 12],
        },
      },
      elevation: {
        theme: "custom-theme",
        detachedView: true,
        elevationDiv: '#elevation-div',
        followPositionMarker: true,
        zFollow: 15,
        legend: false,
      },
    };

	var map = L.map('map', opts.map);

  var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/dark-v10',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(map);




  //Loading GPX from JSON

  function loadGPX(fileList) {
    console.log("---- Loading GPX via JSON ----")
    for (i in fileList){
      console.log(encodeURI(fileList[i].path))
      switch (fileList[i].type){
        case "0-route":
          plotGPX(encodeURI(fileList[i].path), routeColor, " ", 5);
          break;
        case "1-road":
          plotGPX(encodeURI(fileList[i].path), roadColor, " ", 2);
          break;
        case "2-connector":
          plotGPX(encodeURI(fileList[i].path), connectorColor, " ", 2);
          break;
        case "3-gravel":
          plotGPX(encodeURI(fileList[i].path), gravelColor, " ", 2);
          break;
        case "4-recon":
          plotGPX(encodeURI(fileList[i].path), reconColor, "10 5", 2);
          break;
        case "5-caution":
          plotGPX(encodeURI(fileList[i].path), cautionColor, " ", 2);
          break;
        } 

    
    }

}
 

  function plotGPX(path, color, style, thickness) {

  //console.log(gpxList[i])
    var gpx = new L.GPX(path, {
        polyline_options: {
            color: color,
            opacity: 1,
            weight: thickness,
            dashArray: style,
            lineCap: 'round'
        }
    }, {
        async: true
    }).on('loaded', function(e) {
        map.fitBounds(e.target.getBounds());
    }).addTo(map);

    gpx.on('mouseover', function(e) {
        var gpx2 = e.target,
            name = gpx2.get_name()
        gpx2.setStyle({
            weight: 6
        });

        var popLocation = e.latlng;
        var popup = L.popup()
            .setLatLng(popLocation)
            .setContent(name)
            .openOn(map);
    });

    //Callback function for when plot lines are selected
    gpx.on('click', function(e) {
                //Disqus Reset 
                DISQUS.reset({
                    reload: true,
                    config: function() {
                        this.page.identifier = "clear";
                        this.page.url = ("http://tripreport.tk/#!" + encodeURIComponent(gpx2.get_name()));
                    }
                });
                var gpx2 = e.target;
                var converter = new showdown.Converter() // Instantiate Showdown Markdown converter
                
                var mdFilePath = e.target._gpx.substring(0, e.target._gpx.length-3) + "md" // Generate markdown file name hack 

                $.get( mdFilePath , function( result ){
                  console.log("Markdown entry found for " + e.target.get_name());
                  el.clear();
                  sidebar.open('sidebar-info');
                  document.getElementById("sidebar-info").innerHTML = "<h4>" + gpx2.get_name(); + "</h4>";
                  document.getElementById("sidebar-info").innerHTML += converter.makeHtml(result);
                  var g = new L.GPX(e.target._gpx, {async: true});
                  g.addTo(map);
                  g.on("addline", function(e) {
                    el.addData(e.line);
                  });
                  loadDisqus(document.getElementById("disqus_thread"), gpx2.get_name(), (encodeURIComponent(gpx2.get_name())))
                  
              

                  
    
                }).fail((function(){ 
                  console.log("No Markdown entry found for " + e.target.get_name());
                  el.clear();
                  sidebar.open('sidebar-info');
                  document.getElementById("sidebar-info").innerHTML = "<h4>" + gpx2.get_name(); + "</h4>";
                  document.getElementById("sidebar-info").innerHTML += "<p>No Info</p>"
                  var g = new L.GPX(e.target._gpx, {async: true});
                  g.addTo(map);
                  g.on("addline", function(e) {
                    el.addData(e.line);
                  });
                  loadDisqus(document.getElementById("disqus_thread"), gpx2.get_name(), (encodeURIComponent(gpx2.get_name())))
                  })
                  
                );
                
                //Stops the map layer from also receiving a click request
                L.DomEvent.stopPropagation(e);
                
                
                
                gpx2.setStyle({
                    weight: 5
                });
                
                console.log(encodeURIComponent(gpx2.get_name()))
                
                window.location.hash = ('!' + encodeURIComponent(gpx2.get_name()));
                //document.getElementById("info-card").style.visibility = "visible";
                
                
                
                


                gpx2.setStyle({
                    weight: 3
                });
            });

	          gpx.on('mouseout', function(e) {
              //el.clear();
            map.closePopup();
            var gpx2 = e.target
            gpx2.setStyle({
                          weight: thickness
                      });
          });

        

    }


function loadDisqus(element, postTitle, postUrlTag) {
  var identifier = postTitle;

  // Including the hashbang ('/#!') is important.
  var url = window.location.origin + '/#!' + postUrlTag;

  var disqus_identifier = identifier;
  var disqus_url = url;

  if (window.DISQUS) {
    // Horrible, but jQuery wasn't removing the div elements fully
    $( ".comments-load" ).each(function() {
      var len = this.childNodes.length;
      for(var i = 0; i < len; i++)
      {  
        if (this.childNodes[i].tagName == "DIV") {
          this.removeChild(this.childNodes[i]);
        } 
      }
    });

    $(element).append('<div class="disqus-thread" id="disqus_thread"></div>');

    /** if Disqus exists, call it's reset method with new parameters **/
    DISQUS.reset({
      reload: true,
      config: function () { 
        //important to convert it to string
        this.page.identifier = identifier.toString();    
        this.page.url = url;
      }
    });
  }
};


   



    map.on('click', function(e){
        sidebar.close();
        el.clear();
        console.log(window.location.hash);
        window.location.hash = '';

        DISQUS.reset({
                reload: true,
                config: function () {  
                  this.page.identifier = "clear";  
                  this.page.url = ("http://tripreport.tk/#!" + encodeURIComponent(gpx2.get_name()));
                }});
 
    })



	
	
	




var el = L.control.elevation({
  	//position: "topright",
	  theme: "custom-theme", //default: lime-theme
    autofitBounds: false,
    width: 400,
    height: 200,
	  margins: {
		top: 10,
		right: 20,
		bottom: 30,
		left: 50
	},
  xTicks:4,
  followMarker: false,
  almostOver: true,
  slope: "summary",
  summary: false,

  closeBtn:false,

	useHeightIndicator: true, //if false a marker is drawn at map position
	interpolation: d3.curveLinear, //see https://github.com/d3/d3-shape/blob/master/README.md#area_curve
	hoverNumber: {
		decimalsX: 2, //decimals on distance (always in km)
		decimalsY: 0, //deciamls on hehttps://www.npmjs.com/package/leaflet.coordinatesight (always in m)
		formatter: undefined //custom formatter function may be injected
	},
	//xTicks: 4, //number of ticks in x axis, calculated by default according to width
	yTicks: 2, //number of ticks on y axis, calculated by default according to height
	collapsed: false,  //collapsed mode, show chart on click or mouseover
	imperial: false    //display imperial units instead of metric
});

el.addTo(map);

	// Custom Summary info
  el.on('eledata_added', ({layer, name, track_info}) => {

			let q = document.querySelector.bind(document);
			q('.totlen .summaryvalue').innerHTML = track_info.distance.toFixed(2) + " km";
			q('.maxele .summaryvalue').innerHTML = track_info.elevation_max.toFixed(2) + " m";
			q('.minele .summaryvalue').innerHTML = track_info.elevation_min.toFixed(2) + " m";
			q('.gain .summaryvalue').innerHTML   = "+" + track_info.ascent.toFixed(0) + " m";
			q('.loss .summaryvalue').innerHTML   = "-" + track_info.descent.toFixed(0) + " m";
		});


L.control.legend({
    position: "topright",
    legends: [{
                label: "Road",
                type: "polyline",
                color: roadColor,
                fillColor: roadColor,
                weight: 2,
                
            },{
                label: "Connector",
                type: "polyline",
                color: connectorColor,
                fillColor: connectorColor,
                weight: 2,
                
            },{
                label: "Gravel",
                type: "polyline",
                color: gravelColor,
                fillColor: gravelColor,
                weight: 2,
                
            },{
                label: "Caution",
                type: "polyline",
                color: cautionColor,
                fillColor: cautionColor,
                weight: 2,
                
            },
            {
                label: "Recon Route",
                type: "polyline",
                color: reconColor,
                fillColor: reconColor,
                dashArray: [10, 5],
                weight: 2
            }
          ]
}).addTo(map);

  //Loading Data Call
  $.getJSON( "folder.json" , function( result ){
      loadGPX(result);
  });

  //
  // CONFIGURE SIDE PANEL
  //

  var sidebar = L.control.sidebar({
    autopan: true,       // whether to maintain the centered map point when opening the sidebar
    closeButton: true,    // whether t add a close button to the panes
    container: 'sidebar', // the DOM container or #ID of a predefined sidebar container that should be used
    position: 'left',     // left or right
}).addTo(map);



</script>

<script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://bikemap-v1.disqus.com/embed.js';
  s.async = "true";
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();

  



</script>
<script id="dsq-count-scr" src="bikemap-v1.disqus.com/count.js" async></script>
</body>
</html>
